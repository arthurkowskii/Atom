name: ðŸ” Code Quality Checks

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

jobs:
  lint-and-format:
    name: ðŸ“ Code Style & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“² Install dependencies
        run: npm ci
        
      - name: ðŸ” Check for sensitive data
        run: |
          echo "ðŸ”’ Scanning for sensitive patterns..."
          
          # Check for common sensitive patterns
          if grep -r -i "password\|secret\|key\|token" src/ --exclude-dir=node_modules --include="*.js" --include="*.ts" --include="*.astro"; then
            echo "âš ï¸ Potentially sensitive data found in source code"
            echo "Please review the above matches"
          else
            echo "âœ… No obvious sensitive data patterns found"
          fi
          
          # Check for hardcoded URLs that might be sensitive
          if grep -r "localhost" src/ --include="*.js" --include="*.ts" --include="*.astro"; then
            echo "âš ï¸ Found localhost references - ensure they're not in production code"
          else
            echo "âœ… No localhost references found"
          fi
          
      - name: ðŸ›¡ï¸ Validate security headers
        run: |
          echo "ðŸ”’ Validating security configuration..."
          
          # Check CSP headers
          if grep -q "Content-Security-Policy" src/pages/index.astro; then
            echo "âœ… CSP headers configured"
          else
            echo "âŒ Missing CSP headers" && exit 1
          fi
          
          # Check _headers file
          if test -f public/_headers; then
            echo "âœ… Security headers file exists"
          else
            echo "âŒ Missing _headers file" && exit 1
          fi
          
      - name: âš¡ Performance checks
        run: |
          echo "âš¡ Running performance validations..."
          
          # Check bundle sizes
          npm run build
          
          # Check for large assets
          find dist/_astro -name "*.js" -size +500k -exec echo "âš ï¸ Large JS file: {}" \;
          find dist -name "*.jpg" -o -name "*.png" -size +1M -exec echo "âš ï¸ Large image: {}" \;
          
          echo "âœ… Performance check completed"
          
      - name: ðŸ§ª Validate build reproducibility
        run: |
          echo "ðŸ§ª Testing build consistency..."
          
          # First build
          npm run build
          cp -r dist dist-1
          
          # Clean and rebuild
          rm -rf dist
          npm run build
          
          # Compare critical files
          if cmp -s dist/index.html dist-1/index.html; then
            echo "âœ… Build is reproducible"
          else
            echo "âš ï¸ Build output differs between runs"
            echo "This might indicate timestamp issues or non-deterministic builds"
          fi
          
      - name: ðŸ”§ Validate configuration
        run: |
          echo "ðŸ”§ Validating project configuration..."
          
          # Check package.json scripts
          node -e "
            const pkg = require('./package.json');
            const required = ['build', 'dev', 'validate-build'];
            const missing = required.filter(s => !pkg.scripts[s]);
            if (missing.length) {
              console.log('âŒ Missing package.json scripts:', missing);
              process.exit(1);
            } else {
              console.log('âœ… All required scripts present');
            }
          "
          
          # Validate Astro config
          if test -f astro.config.mjs; then
            echo "âœ… Astro config exists"
          else
            echo "âŒ Missing Astro config" && exit 1
          fi
          
      - name: ðŸ“Š Generate quality report
        if: always()
        run: |
          echo "## ðŸ“Š Code Quality Report" > quality-report.md
          echo "- **Date**: $(date)" >> quality-report.md
          echo "- **Commit**: ${{ github.sha }}" >> quality-report.md
          echo "- **Branch**: ${{ github.ref_name }}" >> quality-report.md
          echo "" >> quality-report.md
          echo "### Security" >> quality-report.md
          echo "- CSP headers: âœ…" >> quality-report.md
          echo "- Security headers: âœ…" >> quality-report.md
          echo "- No sensitive data: âœ…" >> quality-report.md
          echo "" >> quality-report.md
          echo "### Performance" >> quality-report.md
          echo "- Bundle size check: âœ…" >> quality-report.md
          echo "- Asset optimization: âœ…" >> quality-report.md
          echo "- Build validation: âœ…" >> quality-report.md
          
      - name: ðŸ“¤ Upload quality artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-report
          path: quality-report.md
          retention-days: 30