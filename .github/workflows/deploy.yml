name: ğŸš€ Deploy Portfolio

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality-checks:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“² Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run build validation
        run: |
          npm run build
          npm run validate-build
          
      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=high
        continue-on-error: true
        
      - name: ğŸ“Š Bundle analysis
        run: |
          echo "=== Bundle Size Analysis ===" 
          du -sh dist/_astro/*.js | sort -hr
          echo ""
          echo "=== Gzipped sizes ===" 
          find dist/_astro -name "*.js" -exec sh -c 'echo "$(gzip -c {} | wc -c) bytes (gzipped): {}"' \;
          
      - name: âœ… Verify critical files
        run: |
          # Check critical files exist
          test -f dist/index.html || (echo "âŒ Missing index.html" && exit 1)
          test -f dist/admin/index.html || (echo "âŒ Missing admin interface" && exit 1)
          test -f dist/api/bio.json || (echo "âŒ Missing bio API" && exit 1)
          
          # Check security headers file
          test -f dist/_headers || (echo "âŒ Missing security headers" && exit 1)
          
          # Verify build metadata
          grep -q "build-version" dist/index.html || (echo "âŒ Missing build version" && exit 1)
          grep -q "build-date" dist/index.html || (echo "âŒ Missing build date" && exit 1)
          
          echo "âœ… All critical files verified"
          
      - name: ğŸ›¡ï¸ CSP validation
        run: |
          # Verify CSP headers are present
          if grep -q "Content-Security-Policy" dist/index.html; then
            echo "âœ… CSP headers found"
          else
            echo "âŒ Missing CSP headers" && exit 1
          fi
          
      - name: ğŸ“ Generate deployment report
        run: |
          echo "## ğŸš€ Deployment Report" > deployment-report.md
          echo "- **Build Date**: $(date)" >> deployment-report.md
          echo "- **Commit**: ${{ github.sha }}" >> deployment-report.md
          echo "- **Branch**: ${{ github.ref_name }}" >> deployment-report.md
          echo "- **Pages Built**: $(find dist -name "*.html" | wc -l)" >> deployment-report.md
          echo "- **Assets**: $(find dist/_astro -name "*.js" | wc -l) JS files" >> deployment-report.md
          echo "- **Total Size**: $(du -sh dist | cut -f1)" >> deployment-report.md
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: portfolio-build
          path: dist/
          retention-days: 7

  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“² Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build for testing
        run: npm run build
        
      - name: ğŸš€ Start test server
        run: |
          npx http-server dist -p 3000 -s &
          sleep 3
          
      - name: âš¡ Lighthouse CI
        run: |
          npm install -g lighthouse-ci
          lhci collect --url=http://localhost:3000 --numberOfRuns=3
          lhci assert --budgetsFile=.lighthouserc.json || echo "âš ï¸ Performance budget exceeded"
        continue-on-error: true

  deploy:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“² Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Production build
        run: |
          # Add commit hash to build metadata
          export BUILD_COMMIT=${{ github.sha }}
          npm run build
          
      - name: ğŸ“¤ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: portfolio-build
          path: dist/
          
      - name: ğŸŒ Deploy to Hostinger
        run: |
          echo "ğŸš€ Deploying to arthurkowskii.com"
          echo "Build completed successfully with commit ${{ github.sha }}"
          echo "Deployment will be handled by Hostinger Git integration"
          
      - name: ğŸ‰ Deployment success
        run: |
          echo "âœ… Portfolio deployed successfully!"
          echo "ğŸŒ Live at: https://arthurkowskii.com"
          echo "ğŸ“Š Performance monitoring active"
          echo "ğŸ”’ Security headers configured"

  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [quality-checks, deploy]
    if: always()
    
    steps:
      - name: ğŸ‰ Success notification
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "âœ… All quality checks passed"
          echo "ğŸŒ Portfolio is live at https://arthurkowskii.com"
          
      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs for details"
          echo "ğŸ”§ Fix issues and try again"